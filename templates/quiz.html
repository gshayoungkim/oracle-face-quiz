{% extends "base.html" %}
{% block title %}í€´ì¦ˆ{% endblock %}

{% block extra_css %}
<style>
  .quiz-wrap { text-align: center; }
  h1 { font-size: 26px; margin-bottom: 8px; }
  .subtitle { font-size: 14px; color: #9ca3af; margin-bottom: 24px; }
  .error { color: #f87171; font-size: 14px; margin-top: 12px; }
  .quiz-box {
    background: #020617;
    border-radius: 18px;
    padding: 32px;
    margin-bottom: 20px;
  }
  .face-img {
    width: 200px;
    height: 200px;
    object-fit: cover;
    border-radius: 16px;
    margin-bottom: 20px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  }
  .options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-top: 16px;
  }
  .option-btn {
    padding: 12px;
    border-radius: 12px;
    border: 2px solid #374151;
    background: #1e293b;
    color: #e5e7eb;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .option-btn:hover {
    border-color: #4f46e5;
    background: #312e81;
  }
  .option-btn.correct {
    border-color: #22c55e;
    background: #065f46;
  }
  .option-btn.wrong {
    border-color: #ef4444;
    background: #7f1d1d;
  }
  .progress {
    font-size: 13px;
    color: #a5b4fc;
    margin-bottom: 12px;
  }
  .score-display {
    font-size: 15px;
    color: #fbbf24;
    font-weight: 600;
    margin-bottom: 16px;
  }
  .result-box {
    margin-top: 24px;
    padding: 24px;
    background: #1e293b;
    border-radius: 16px;
  }
  .result-box h2 {
    font-size: 22px;
    margin-bottom: 8px;
    color: #22c55e;
  }
  .result-box p {
    font-size: 14px;
    color: #9ca3af;
    margin-bottom: 16px;
  }
  #username-input {
    width: 100%;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid #4b5563;
    background: #0f172a;
    color: #e5e7eb;
    font-size: 14px;
    margin-bottom: 12px;
  }
</style>
{% endblock %}

{% block content %}
<div class="quiz-wrap">
  {% if error %}
    <div class="card">
      <h1>âŒ ì˜¤ë¥˜</h1>
      <p class="error">{{ error }}</p>
      <a href="/upload" class="btn-primary" style="margin-top:16px; display:inline-block; text-decoration:none;">ë©¤ë²„ ë“±ë¡í•˜ëŸ¬ ê°€ê¸°</a>
    </div>
  {% else %}
    <div class="card">
      <h1>ğŸ¯ ì–¼êµ´ í€´ì¦ˆ</h1>
      <p class="subtitle">ì‚¬ì§„ ì† ì¸ë¬¼ì˜ ì´ë¦„ì„ ë§ì¶°ë³´ì„¸ìš”!</p>

      <div id="quiz-container">
        <div class="progress" id="progress">ë¬¸ì œ 1 / {{ members|length }}</div>
        <div class="score-display" id="score-display">ì ìˆ˜: 0 / {{ members|length }}</div>

        <div class="quiz-box">
          <img id="face-img" class="face-img" src="" alt="ì–¼êµ´">
          <div class="options" id="options"></div>
        </div>
      </div>

      <div id="result-box" class="result-box" style="display:none;">
  <h2>ğŸ‰ í€´ì¦ˆ ì™„ë£Œ!</h2>
  <p id="final-score"></p>

  <label for="username-select-result" style="font-size:13px; color:#9ca3af; display:block; text-align:left; margin-bottom:4px;">
    ë¦¬ë”ë³´ë“œì— í‘œì‹œí•  ì´ë¦„
  </label>
  <select id="username-select-result" style="width:100%; padding:9px 11px; border-radius:8px; border:1px solid #4b5563; background:#0f172a; color:#e5e7eb; font-size:14px; margin-bottom:12px;">
    <option value="">ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš” (ì„ íƒ ì•ˆ í•˜ë©´ ìµëª…)</option>
  </select>

  <button class="btn-primary" id="save-btn" style="width:100%; margin-bottom:8px;">ì ìˆ˜ ì €ì¥í•˜ê¸°</button>
  <a href="/quiz" class="btn-secondary" style="width:100%; text-align:center; display:block; margin-top:8px;">ë‹¤ì‹œ ë„ì „</a>
</div>

    </div>
  {% endif %}
</div>

{% if not error %}
<script>
  const members = {{ members | tojson }};
  let currentIndex = 0;
  let score = 0;

  function shuffle(arr) {
    return arr.sort(() => Math.random() - 0.5);
  }

    function renderQuestion() {
  if (currentIndex >= members.length) {
    showResult();
    return;
  }

  const current = members[currentIndex];
  document.getElementById('progress').textContent = `ë¬¸ì œ ${currentIndex + 1} / ${members.length}`;
  document.getElementById('score-display').textContent = `ì ìˆ˜: ${score} / ${members.length}`;
  document.getElementById('face-img').src = current.image_url;

  const allNames = members.map(m => m.name);
  const otherNames = allNames.filter(n => n !== current.name);
  shuffle(otherNames);

  // ì‹¤ì œ ì‚¬ìš©í•  ë³´ê¸° ìˆ˜: ë©¤ë²„ ìˆ˜ê°€ 4ëª… ë¯¸ë§Œì´ë©´ ê·¸ë§Œí¼ë§Œ
  const optionCount = Math.min(4, 1 + otherNames.length);
  const choices = shuffle([current.name, ...otherNames.slice(0, optionCount - 1)]);

  const optionsDiv = document.getElementById('options');
  optionsDiv.innerHTML = '';
  choices.forEach(name => {
    const btn = document.createElement('button');
    btn.className = 'option-btn';
    btn.textContent = name;
    btn.onclick = () => checkAnswer(name, current.name, btn);
    optionsDiv.appendChild(btn);
  });
}


  function checkAnswer(selected, correct, btn) {
    const btns = document.querySelectorAll('.option-btn');
    btns.forEach(b => b.disabled = true);

    if (selected === correct) {
      btn.classList.add('correct');
      score++;
    } else {
      btn.classList.add('wrong');
      btns.forEach(b => {
        if (b.textContent === correct) b.classList.add('correct');
      });
    }

    setTimeout(() => {
      currentIndex++;
      renderQuestion();
    }, 1200);
  }

  function showResult() {
    document.getElementById('quiz-container').style.display = 'none';
    document.getElementById('result-box').style.display = 'block';
    const accuracy = ((score / members.length) * 100).toFixed(1);
    document.getElementById('final-score').textContent =
      `${score} / ${members.length} (ì •í™•ë„: ${accuracy}%)`;

    // ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
    const sel = document.getElementById('username-select-result');
    sel.innerHTML = '<option value="">ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš” (ì„ íƒ ì•ˆ í•˜ë©´ ìµëª…)</option>';
    AI_STUDY_NAMES.forEach(n => {
      const opt = document.createElement('option');
      opt.value = n;
      opt.textContent = n;
      sel.appendChild(opt);
    });

    // localStorageì— ì €ì¥ëœ ì´ë¦„ì´ ìˆìœ¼ë©´ ì„ íƒ
    const saved = localStorage.getItem('ai_study_username');
    if (saved && AI_STUDY_NAMES.includes(saved)) {
      sel.value = saved;
    }
  }

  document.getElementById('save-btn').addEventListener('click', async () => {
    const sel = document.getElementById('username-select-result');
    let username = sel.value.trim() || 'ìµëª…';

    if (username !== 'ìµëª…') {
      localStorage.setItem('ai_study_username', username);
    } else {
      localStorage.removeItem('ai_study_username');
    }

    try {
      await fetch('/api/quiz_submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_name: username,
          score: score,
          total: members.length
        })
      });
      alert('ì ìˆ˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
      window.location.href = '/leaderboard';
    } catch (err) {
      alert('ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨');
    }
  });

  renderQuestion();
</script>
{% endif %}
{% endblock %}
