{% extends "base.html" %}
{% block title %}멤버 등록{% endblock %}

{% block extra_css %}
<style>
  .upload-card { max-width: 500px; margin: 0 auto; }
  h1 { font-size: 24px; margin-bottom: 6px; }
  .desc { font-size: 13px; color: #9ca3af; margin-bottom: 20px; }
  label {
    display: block;
    font-size: 14px;
    margin-top: 14px;
    margin-bottom: 6px;
    color: #a5b4fc;
  }
  input[type="text"], textarea {
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #4b5563;
    background: #111827 ;
    color: #e5e7eb;
    font-size: 14px;
  }
  input[type="file"] {
    font-size: 13px;
    color: #9ca3af;
  }
  .submit-btn {
    margin-top: 18px;
    width: 100%;
    padding: 12px 0;
    border: none;
    border-radius: 999px;
    background: linear-gradient(135deg, #4f46e5, #22c55e);
    color: white;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
  }
  .submit-btn:disabled {
    background: #374151;
    cursor: default;
  }
  .msg {
    margin-top: 12px;
    font-size: 13px;
  }
  .msg.error { color: #f87171; }
  .msg.success { color: #22c55e; }
  .preview {
    margin-top: 16px;
    text-align: center;
  }
  .preview img {
    max-width: 160px;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  }
  .preview-name {
    margin-top: 8px;
    font-weight: 600;
  }
  .name-select {
  width: 100%;
  padding: 9px 11px;
  border-radius: 8px;
  border: 1px solid #4b5563;
  background: #1f2937;
  color: #e5e7eb;
  font-size: 14px;
}
</style>
{% endblock %}

{% block content %}
<div class="card upload-card">
  <h1>AI-Study 멤버 등록</h1>
  <p class="desc"> 얼굴 사진과 이름을 등록하면, 퀴즈에서 바로 사용할 수 있어요.</p>

  <form id="upload-form" enctype="multipart/form-data">
    <label for="name">이름</label>
    <select id="name" name="name" required class="name-select">
    <option value="">이름을 선택하세요</option>
    </select>

    <label for="photo">얼굴 사진</label>
    <input type="file" id="photo" name="photo" accept="image/*" required>

    <label for="bio">한 줄 소개 (선택)</label>
    <textarea id="bio" name="bio" rows="2" placeholder="예: NLP 좋아하는 데이터 사이언티스트"></textarea>

    <button type="submit" id="submit-btn" class="submit-btn">멤버 등록</button>

    <div class="msg" id="message"></div>

    <div class="preview" id="preview" style="display:none;">
      <p style="font-size:13px; color:#9ca3af;">등록된 프로필 이미지:</p>
      <img id="preview-img" src="" alt="미리보기">
      <div id="preview-name" class="preview-name"></div>
    </div>
  </form>
</div>
<script>
  // 이름 드롭다운 채우기
  const nameSelect = document.getElementById('name');
  AI_STUDY_NAMES.forEach(n => {
    const opt = document.createElement('option');
    opt.value = n;
    opt.textContent = n;
    nameSelect.appendChild(opt);
  });

  const form = document.getElementById('upload-form');
  const btn = document.getElementById('submit-btn');
  const msg = document.getElementById('message');
  const preview = document.getElementById('preview');
  const previewImg = document.getElementById('preview-img');
  const previewName = document.getElementById('preview-name');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.textContent = '';
    msg.className = 'msg';
    btn.disabled = true;
    btn.textContent = '업로드 중...';

    const formData = new FormData(form);

    try {
      const res = await fetch('/api/upload_member', {
        method: 'POST',
        body: formData,
      });
      const data = await res.json();

      if (!res.ok || !data.success) {
        msg.textContent = data.error || '업로드 실패';
        msg.classList.add('error');
        preview.style.display = 'none';
      } else {
        msg.textContent = data.message || '업로드 성공!';
        msg.classList.add('success');

        if (data.member && data.member.image_url) {
          previewImg.src = data.member.image_url;
          previewName.textContent = data.member.name;
          preview.style.display = 'block';
        }
        form.reset();
        nameSelect.selectedIndex = 0;
      }
    } catch (err) {
      msg.textContent = '업로드 중 오류가 발생했습니다.';
      msg.classList.add('error');
      preview.style.display = 'none';
    } finally {
      btn.disabled = false;
      btn.textContent = '멤버 등록';
    }
  });
</script>

<script>
  const form = document.getElementById('upload-form');
  const btn = document.getElementById('submit-btn');
  const msg = document.getElementById('message');
  const preview = document.getElementById('preview');
  const previewImg = document.getElementById('preview-img');
  const previewName = document.getElementById('preview-name');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.textContent = '';
    msg.className = 'msg';
    btn.disabled = true;
    btn.textContent = '업로드 중...';

    const formData = new FormData(form);

    try {
      const res = await fetch('/api/upload_member', {
        method: 'POST',
        body: formData,
      });
      const data = await res.json();

      if (!res.ok || !data.success) {
        msg.textContent = data.error || '업로드 실패';
        msg.classList.add('error');
        preview.style.display = 'none';
      } else {
        msg.textContent = data.message || '업로드 성공!';
        msg.classList.add('success');

        if (data.member && data.member.image_url) {
          previewImg.src = data.member.image_url;
          previewName.textContent = data.member.name;
          preview.style.display = 'block';
        }
        form.reset();
      }
    } catch (err) {
      msg.textContent = '업로드 중 오류가 발생했습니다.';
      msg.classList.add('error');
      preview.style.display = 'none';
    } finally {
      btn.disabled = false;
      btn.textContent = '멤버 등록';
    }
  });
</script>
{% endblock %}
